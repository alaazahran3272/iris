<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<title>Ù‚ÙŠØ§Ø³ Ù‚Ø·Ø± Ø§Ù„Ù‚Ø²Ø­ÙŠØ© â€” V4 (Ø±ÙØ¹ ØµÙˆØ±Ø© + Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚ÙˆÙŠØ©)</title>
<style>
  :root { --pad: 12px; --radius: 12px; }
  html, body { margin:0; padding:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Naskh Arabic UI", "Helvetica Neue", Arial, "Noto Color Emoji", sans-serif; background:#0b0f14; color:#e8eef6; }
  header { padding: var(--pad); text-align:center; background:#0f1720; position:sticky; top:0; z-index:5; border-bottom:1px solid #1f2a36; }
  header h1 { margin:0; font-size: 1.1rem; }
  main { padding: var(--pad); display: grid; gap: 16px; max-width: 980px; margin: 0 auto; }
  section { background:#0f1720; border:1px solid #1f2a36; border-radius: var(--radius); padding: var(--pad); }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  label { font-size: .9rem; opacity:.9; }
  input, select, textarea, button { border-radius: 10px; border:1px solid #223246; background:#111b27; color:#e8eef6; padding:10px 12px; font-size:16px; }
  input:focus, textarea:focus, button:focus { outline: 2px solid #2c7be5; }
  button { cursor:pointer; }
  button.primary { background:#2c7be5; border-color:#2c7be5; color:white; }
  button.ghost { background:transparent; }
  .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .grid3 { display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .hint { font-size:.85rem; color:#9fb4cc; }
  .chip { border:1px dashed #2c7be5; padding:6px 10px; border-radius:999px; font-size:.8rem; }
  canvas, img.preview { width: 100%; max-height: 70vh; border-radius: 12px; background:#02060a; object-fit: contain; }
  .table { width:100%; border-collapse: collapse; }
  .table th, .table td { border-bottom:1px solid #1f2a36; padding:8px; font-size:.9rem; text-align: right; }
  .muted { opacity:.7; }
  .badge { padding:2px 8px; border-radius:999px; background:#142034; border:1px solid #24364a; font-size:.75rem; }
  .nowrap { white-space: nowrap; }
  .warn { color:#ffd166; }
  .error { color:#ff8a8a; }
  .ok { color:#7be27b; }
  #toast { position: fixed; bottom: 16px; right: 16px; background:#0b1520; border:1px solid #1e2c3c; padding:10px 12px; border-radius:10px; display:none; }
  #log { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#0b1520; border:1px solid #1e2c3c; border-radius:12px; padding:10px; max-height:220px; overflow:auto; }
  @media (max-width: 680px){ .grid2, .grid3 { grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <header>
    <h1>ğŸ§¿ Ù‚ÙŠØ§Ø³ Ù‚Ø·Ø± Ø§Ù„Ù‚Ø²Ø­ÙŠØ© â€” V4 (Ø±ÙØ¹ ØµÙˆØ±Ø© + Ù…Ø¹Ø§ÙŠÙ†Ø© Ù‚ÙˆÙŠØ©)</h1>
  </header>

  <main>
    <section>
      <div class="hint">Ù„Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ø´ Ø¸Ø§Ù‡Ø±Ø© Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§ØªØŒ Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆÙÙŠ Ø¢Ø®Ø±Ù‡ <code>?v=4</code> Ø£Ùˆ Ø§Ø¹Ù…Ù„ <b>Ctrl + F5</b>.</div>
    </section>

    <section id="upload">
      <h3>Ø±ÙØ¹ ØµÙˆØ±Ø©</h3>
      <div class="row">
        <input id="file" type="file" accept="image/*">
        <button id="btnToCanvas" class="primary">Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©</button>
        <button id="btnGrid" class="ghost">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø³Ù… (Ø´Ø¨ÙƒØ©)</button>
        <span class="hint">Ù¡) Ø§Ø®ØªØ± ØµÙˆØ±Ø© â†’ Ù¢) Ø³ØªØ¸Ù‡Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© â†’ Ù£) Ø§Ø¶ØºØ· "Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©".</span>
      </div>
      <div class="grid2" style="margin-top:8px;">
        <img id="preview" class="preview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© (Ù‚Ø¨Ù„ Ø§Ù„Ø±Ø³Ù…)">
        <canvas id="photo"></canvas>
      </div>
      <div id="errorMsg" class="error"></div>
      <div id="log"></div>
    </section>

    <section id="client">
      <h3>Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© ÙˆØ§Ù„Ù‚ÙŠØ§Ø³ + Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
      <div class="row">
        <span>Ø·ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¬Ø¹ (Ù…Ù…):</span>
        <input id="knownMM" type="number" step="0.01" value="10" style="width:110px">
        <button id="resetLine">Ù…Ø³Ø­ Ø®Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©</button>
      </div>
      <div class="hint">Ø§Ø±Ø³Ù… Ø®Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© Ø¨Ø§Ù„Ø³Ø­Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© (ÙŠÙ…ÙŠÙ†)ØŒ Ø«Ù… Ø§ÙƒØªØ´Ù Ø§Ù„Ù‚Ø²Ø­ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø£Ùˆ ÙŠØ¯ÙˆÙŠÙ‹Ø§.</div>
      <div class="row" style="margin-top:8px;">
        <button id="autoDetect" class="primary">Ø§ÙƒØªØ´Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ (OpenCV)</button>
        <button id="manualCircle">Ø±Ø³Ù… Ø¯Ø§Ø¦Ø±Ø© ÙŠØ¯ÙˆÙŠ</button>
        <label>Threshold: <input id="th" type="range" min="10" max="200" value="80"> <span id="thVal">80</span></label>
      </div>
      <div class="row">
        <span id="diameterOut" class="badge">Ø§Ù„Ù‚Ø·Ø±: -</span>
        <span id="pxOut" class="badge">px/Ù…Ù…: -</span>
      </div>

      <div class="grid3" style="margin-top:10px;">
        <div>
          <label>Ø§Ù„Ø§Ø³Ù…</label>
          <input id="name" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ" autocomplete="name">
        </div>
        <div>
          <label>Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="phone" placeholder="01xxxxxxxxx" inputmode="tel" autocomplete="tel">
        </div>
        <div>
          <label>Ø§Ù„ÙƒÙˆØ¯</label>
          <input id="code" placeholder="Ù…Ø«Ø§Ù„: C-1021">
        </div>
      </div>
      <div class="grid2" style="margin-top:10px;">
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea id="notes" rows="2" placeholder="Ø£ÙƒØªØ¨ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©..."></textarea>
        </div>
        <div>
          <label>Ø§Ù„Ø¹ÙŠÙ†</label>
          <select id="eye">
            <option value="right">Ø§Ù„ÙŠÙ…Ù†Ù‰</option>
            <option value="left">Ø§Ù„ÙŠØ³Ø±Ù‰</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <button id="saveRecord">Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³ + Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        <button id="exportCSV">ØªØµØ¯ÙŠØ± CSV</button>
        <button id="clearAll" class="danger">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
      </div>
      <div class="hint">Ø§Ù„Ø³Ø¬Ù„Ø§Øª ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø· (localStorage).</div>
    </section>

    <section id="records">
      <h3>Ø§Ù„Ø³Ø¬Ù„Ø§Øª</h3>
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø§Ø³Ù…</th>
            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
            <th>Ø§Ù„ÙƒÙˆØ¯</th>
            <th>Ø§Ù„Ø¹ÙŠÙ†</th>
            <th>Ø§Ù„Ù‚Ø·Ø± (Ù…Ù…)</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <footer>Â© 2025 â€” Ø£Ø¯Ø§Ø© Ù‚ÙŠØ§Ø³ Ø§Ù„Ù‚Ø²Ø­ÙŠØ© â€” V4</footer>
  </main>

  <div id="toast"></div>

  <!-- OpenCV.js CDN -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const preview = $('#preview');
    const photo = $('#photo');
    const ctx = photo.getContext('2d', { willReadFrequently: true });
    let calibLine = null;
    let scalePxPerMM = null;
    let manualPts = [];
    let lastCircle = null;
    let loadedBlobUrl = null;

    const logBox = $('#log');
    function log(msg){
      const p = document.createElement('div');
      p.textContent = new Date().toLocaleTimeString('ar-EG') + ' â€” ' + msg;
      logBox.prepend(p);
    }
    function toast(msg){
      const t = $('#toast');
      t.textContent = msg;
      t.style.display = 'block';
      setTimeout(()=> t.style.display='none', 2200);
    }

    // ====== PREVIEW LOADING (objectURL + FileReader fallback) ======
    $('#file').addEventListener('change', (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f){ toast('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù'); log('Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù'); return; }
      $('#errorMsg').textContent = '';
      log('Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù: ' + (f.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…') + ' â€” ' + (f.type || 'Ù†ÙˆØ¹ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') + ' â€” ' + f.size + ' Ø¨Ø§ÙŠØª');
      // 1) Try objectURL
      try{
        if(loadedBlobUrl) URL.revokeObjectURL(loadedBlobUrl);
        loadedBlobUrl = URL.createObjectURL(f);
        preview.src = loadedBlobUrl;
        preview.onload = ()=>{ toast('ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© â€” Ø§Ø¶ØºØ· "Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©"'); log('Ù…Ø¹Ø§ÙŠÙ†Ø© Ù†Ø¬Ø­Øª Ø¹Ø¨Ø± objectURL'); };
        preview.onerror = ()=>{
          log('ÙØ´Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ø¨Ø± objectURL â€” Ø³Ù†Ø¬Ø±Ø¨ FileReader dataURL');
          // 2) Fallback: FileReader -> dataURL
          const reader = new FileReader();
          reader.onload = (e)=>{
            preview.src = e.target.result;
            preview.onload = ()=>{ toast('ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (dataURL) â€” Ø§Ø¶ØºØ· "Ø¹Ø±Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©"'); log('Ù…Ø¹Ø§ÙŠÙ†Ø© Ù†Ø¬Ø­Øª Ø¹Ø¨Ø± dataURL'); };
            preview.onerror = ()=>{
              $('#errorMsg').textContent = 'ØªØ¹Ø°Ù‘Ø± Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©. Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„ØµÙŠØºØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© (HEIC?).';
              log('ÙØ´Ù„ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ø¹Ø¨Ø± dataURL');
            };
          };
          reader.onerror = ()=>{ $('#errorMsg').textContent = 'ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.'; log('FileReader error'); };
          reader.readAsDataURL(f);
        };
      }catch(e){
        $('#errorMsg').textContent = 'Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©: ' + e;
        log('Exception preview: ' + e);
      }
    });

    // Draw preview into canvas
    $('#btnToCanvas').addEventListener('click', ()=>{
      if(!preview.src){ toast('Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
      try{
        const img = new Image();
        img.onload = ()=>{
          const maxW = 900;
          const scale = Math.min(1, maxW / img.width);
          const w = Math.max(1, Math.round(img.width * scale));
          const h = Math.max(1, Math.round(img.height * scale));
          photo.width = w; photo.height = h;
          ctx.clearRect(0,0,w,h);
          ctx.drawImage(img, 0, 0, w, h);
          calibLine = null; manualPts = []; lastCircle = null; scalePxPerMM = null;
          $('#diameterOut').textContent='Ø§Ù„Ù‚Ø·Ø±: -'; $('#pxOut').textContent='px/Ù…Ù…: -';
          toast('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©'); log('Ø±ÙØ³Ù…Øª Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©: ' + w + 'x' + h);
        };
        img.src = preview.src;
      }catch(e){
        $('#errorMsg').textContent = 'ØªØ¹Ø°Ù‘Ø± Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©: '+e;
        log('Canvas draw error: ' + e);
      }
    });

    // Draw test grid to confirm canvas works
    $('#btnGrid').addEventListener('click', ()=>{
      const w = 800, h = 450;
      photo.width = w; photo.height = h;
      ctx.clearRect(0,0,w,h);
      for(let x=0; x<=w; x+=50){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.strokeStyle='#233548'; ctx.stroke(); }
      for(let y=0; y<=h; y+=50){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.strokeStyle='#233548'; ctx.stroke(); }
      ctx.font='14px ui-monospace'; ctx.fillStyle='#9fb4cc'; ctx.fillText('Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø±Ø³Ù…: Ù„Ùˆ Ø´Ø§ÙŠÙ Ø§Ù„Ø´Ø¨ÙƒØ© ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ù€Canvas Ø´ØºØ§Ù„', 10, 20);
      calibLine = null; manualPts = []; lastCircle = null; scalePxPerMM = null;
      $('#diameterOut').textContent='Ø§Ù„Ù‚Ø·Ø±: -'; $('#pxOut').textContent='px/Ù…Ù…: -';
      toast('Ø±ÙØ³Ù…Øª Ø´Ø¨ÙƒØ© Ø§Ø®ØªØ¨Ø§Ø±'); log('ØªÙ… Ø±Ø³Ù… Ø´Ø¨ÙƒØ© Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©');
    });

    // ====== CALIBRATION & DETECTION ======
    photo.addEventListener('pointerdown', (e)=>{
      if(photo.width===0 || photo.height===0){ toast('Ø§Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© Ø£ÙˆÙ„Ù‹Ø§'); return; }
      const rect = photo.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      if($('#manualCircle').dataset.active === '1'){
        manualPts.push({x,y}); redraw();
        if(manualPts.length === 3){
          const c = circleFrom3Points(manualPts[0], manualPts[1], manualPts[2]);
          if(c){ lastCircle = c; redraw(); computeDiameter(); } else { alert('ØªØ¹Ø°Ù‘Ø± ØªÙ‚Ø±ÙŠØ¨ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©.'); }
          manualPts = [];
          const btn = document.getElementById('manualCircle');
          btn.dataset.active = '0'; btn.textContent = 'Ø±Ø³Ù… Ø¯Ø§Ø¦Ø±Ø© ÙŠØ¯ÙˆÙŠ';
        }
        return;
      }
      calibLine = {x1:x,y1:y,x2:x,y2:y, dragging:true};
      redraw();
    });
    photo.addEventListener('pointermove', (e)=>{
      if(!calibLine || !calibLine.dragging) return;
      const rect = photo.getBoundingClientRect();
      calibLine.x2 = e.clientX - rect.left;
      calibLine.y2 = e.clientY - rect.top;
      redraw();
    });
    photo.addEventListener('pointerup', ()=>{
      if(calibLine){ calibLine.dragging=false; computeScale(); }
    });

    function redraw(){
      // overlays
      if(calibLine){
        ctx.beginPath();
        ctx.moveTo(calibLine.x1, calibLine.y1);
        ctx.lineTo(calibLine.x2, calibLine.y2);
        ctx.strokeStyle = '#7be27b';
        ctx.lineWidth = 2;
        ctx.stroke();
      }
      if(lastCircle){
        ctx.beginPath();
        ctx.arc(lastCircle.x, lastCircle.y, lastCircle.r, 0, Math.PI*2);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#2c7be5';
        ctx.stroke();
      }
      if(manualPts.length){
        ctx.fillStyle = '#ffd166';
        for(const p of manualPts){ ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill(); }
      }
    }

    function computeScale(){
      if(!calibLine) return;
      const dx = calibLine.x2 - calibLine.x1;
      const dy = calibLine.y2 - calibLine.y1;
      const px = Math.hypot(dx,dy);
      const mm = parseFloat($('#knownMM').value||'0');
      if(mm > 0 && px > 5){
        scalePxPerMM = px/mm;
        $('#pxOut').textContent = 'px/Ù…Ù…: ' + scalePxPerMM.toFixed(2);
        toast('ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ù…Ù‚ÙŠØ§Ø³');
      }else{
        alert('ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø·ÙˆÙ„ Ù…Ø±Ø¬Ø¹ ØµØ­ÙŠØ­ ÙˆØ±Ø³Ù… Ø®Ø· ÙˆØ§Ø¶Ø­.');
      }
    }

    function circleFrom3Points(p1,p2,p3){
      const x1=p1.x, y1=p1.y, x2=p2.x, y2=p2.y, x3=p3.x, y3=p3.y;
      const a = x1*(y2 - y3) - y1*(x2 - x3) + x2*y3 - x3*y2;
      if(Math.abs(a) < 1e-6) return null;
      const b = ( (x1*x1 + y1*y1)*(y2 - y3) + (x2*x2 + y2*y2)*(y3 - y1) + (x3*x3 + y3*y3)*(y1 - y2) )/(2*a);
      const c = ( (x1*x1 + y1*y1)*(x3 - x2) + (x2*x2 + y2*y2)*(x1 - x3) + (x3*x3 + y3*y3)*(x2 - x1) )/(2*a);
      const xc = b, yc = c;
      const r = Math.hypot(x1 - xc, y1 - yc);
      return {x: xc, y: yc, r: r};
    }

    async function autoDetect(){
      if(!window.cv || !cv.cvtColor){ alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ OpenCV Ø¨Ø¹Ø¯.'); return; }
      const w = photo.width, h = photo.height;
      if(!w || !h){ alert('Ø§Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø© Ø£ÙˆÙ„Ù‹Ø§.'); return; }
      const src = new cv.Mat(h, w, cv.CV_8UC4);
      try{ cv.imread(photo, src); }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© OpenCV'); return; }
      const gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      const blur = new cv.Mat(); cv.medianBlur(gray, blur, 5);
      const circles = new cv.Mat();
      const dp = 1.2;
      const minDist = Math.round(Math.min(w,h)/8);
      const param1 = 100;
      const param2 = parseInt($('#th').value);
      const minRadius = Math.round(Math.min(w,h)/16);
      const maxRadius = Math.round(Math.min(w,h)/3);
      cv.HoughCircles(blur, circles, cv.HOUGH_GRADIENT, dp, minDist, param1, param2, minRadius, maxRadius);
      lastCircle = null;
      for (let i = 0; i < circles.cols; ++i) {
        const x = circles.data32F[i*3];
        const y = circles.data32F[i*3+1];
        const r = circles.data32F[i*3+2];
        if(!lastCircle || Math.abs(x-w/2)+Math.abs(y-h/2) < Math.abs(lastCircle.x-w/2)+Math.abs(lastCircle.y-h/2)){
          lastCircle = {x, y, r};
        }
      }
      src.delete(); gray.delete(); blur.delete(); circles.delete();
      if(lastCircle){ redraw(); computeDiameter(); toast('ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù‚Ø²Ø­ÙŠØ©'); }
      else { alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø§Ø¦Ø±Ø© Ù…Ù†Ø§Ø³Ø¨Ø©.'); }
    }

    function computeDiameter(){
      if(!lastCircle){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø§Ø¦Ø±Ø© Ù…Ø­Ø¯Ø¯Ø©.'); return; }
      const pxDiameter = 2*lastCircle.r;
      if(!scalePxPerMM){
        $('#diameterOut').textContent = 'Ø§Ù„Ù‚Ø·Ø± (Ø¨Ø¯ÙˆÙ† Ù…Ø¹Ø§ÙŠØ±Ø©): ' + pxDiameter.toFixed(1) + ' px';
        return;
      }
      const mm = pxDiameter / scalePxPerMM;
      $('#diameterOut').textContent = 'Ø§Ù„Ù‚Ø·Ø±: ' + mm.toFixed(2) + ' Ù…Ù…';
    }

    // Records
    function loadRecords(){ try{ return JSON.parse(localStorage.getItem('records')||'[]'); }catch{ return []; } }
    function saveRecords(arr){ localStorage.setItem('records', JSON.stringify(arr)); renderTable(); }
    function renderTable(){
      const tbody = document.querySelector('#tbl tbody');
      tbody.innerHTML='';
      for(const r of loadRecords()){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="nowrap">${r.date}</td>
          <td>${r.name||''}</td>
          <td>${r.phone||''}</td>
          <td>${r.code||''}</td>
          <td>${r.eye||''}</td>
          <td><strong>${(+r.iris_mm).toFixed(2)}</strong></td>
          <td class="muted">${r.notes||''}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    $('#saveRecord').addEventListener('click', ()=>{
      if(!lastCircle){ alert('Ø­Ø¯Ø¯ Ø§Ù„Ù‚Ø²Ø­ÙŠØ© Ø£ÙˆÙ„Ù‹Ø§ (ØªÙ„Ù‚Ø§Ø¦ÙŠ/ÙŠØ¯ÙˆÙŠ).'); return; }
      const pxDiameter = 2*lastCircle.r;
      let irisMM = null;
      if(scalePxPerMM){ irisMM = (pxDiameter/scalePxPerMM).toFixed(2); }
      const rec = {
        date: new Date().toLocaleString('ar-EG'),
        name: $('#name').value.trim(),
        phone: $('#phone').value.trim(),
        code: $('#code').value.trim(),
        eye: $('#eye').value,
        iris_mm: irisMM || ('~'+pxDiameter.toFixed(1)+'px'),
        notes: $('#notes').value.trim()
      };
      const arr = loadRecords(); arr.unshift(rec); saveRecords(arr);
      toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³');
    });

    $('#exportCSV').addEventListener('click', ()=>{
      const rows = loadRecords();
      if(!rows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±.'); return; }
      const header = ['date','name','phone','code','eye','iris_mm','notes'];
      const escape = (v) => ('"'+String(v).replaceAll('"','""')+'"');
      const lines = [header.map(escape).join(',')];
      for(const r of rows){ lines.push([r.date,r.name,r.phone,r.code,r.eye,r.iris_mm,r.notes].map(escape).join(',')); }
      const csv = lines.join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'iris_measurements.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
      toast('ØªÙ… ØªÙ†Ø²ÙŠÙ„ CSV');
    });

    $('#clearAll').addEventListener('click', ()=>{
      if(confirm('Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§ØªØŸ')){ localStorage.removeItem('records'); renderTable(); toast('ØªÙ… Ø§Ù„Ø­Ø°Ù'); }
    });
    $('#resetLine').addEventListener('click', ()=>{calibLine=null; $('#pxOut').textContent='px/Ù…Ù…: -'; scalePxPerMM=null; toast('ØªÙ… Ù…Ø³Ø­ Ø®Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©');});
    $('#autoDetect').addEventListener('click', autoDetect);
    $('#manualCircle').addEventListener('click', (e)=>{
      if(e.target.dataset.active === '1'){
        e.target.dataset.active = '0'; e.target.textContent = 'Ø±Ø³Ù… Ø¯Ø§Ø¦Ø±Ø© ÙŠØ¯ÙˆÙŠ';
        toast('Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ');
      }else{
        e.target.dataset.active = '1'; e.target.textContent = 'â€” ÙˆØ¶Ø¹ Ø§Ù„Ø±Ø³Ù… Ø§Ù„ÙŠØ¯ÙˆÙŠ: Ø§Ø¶ØºØ· 3 Ù†Ù‚Ø§Ø· â€”'; manualPts = [];
        toast('Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙŠØ¯ÙˆÙŠ');
      }
    });
    $('#th').addEventListener('input', (e)=> $('#thVal').textContent = e.target.value);

    // init
    renderTable();
  </script>
</body>
</html>
